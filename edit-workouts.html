<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Manage Plan - Fitness Tracker</title>
    <link rel="stylesheet" href="edit-workouts-style.css">
    <link rel="icon" href="images/eagle.png" type="image/png">
</head>
<body>
    <div id="toast-container"></div>
    <svg style="display: none;">
        <symbol id="icon-reorder" viewBox="0 0 24 24" fill="none" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5 7.5 3m0 0L12 7.5M7.5 3v13.5m13.5 0L16.5 21m0 0L12 16.5m4.5 4.5V7.5" />
        </symbol>
        <symbol id="icon-arrow-back" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 6L9 12L15 18"/>
        </symbol>
        <symbol id="icon-ellipsis-vertical" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" />
        </symbol>
        <symbol id="icon-close" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></symbol>
        <symbol id="icon-share" viewBox="0 0 24 24" fill="none">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
        </symbol>
        <symbol id="icon-cancel-circle-sharp" viewBox="0 0 24 24" fill="none">
            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke-width="1.5"/>
            <path d="M14.5 9.5L9.5 14.5" stroke-width="1.5" stroke-linecap="sharp"/>
            <path d="M9.5 9.5L14.5 14.5" stroke-width="1.5" stroke-linecap="sharp"/>
        </symbol>
        <symbol id="icon-file-import" viewBox="0 0 24 24" fill="currentColor">
            <path fill-rule="evenodd" d="M5.625 1.5H9a3.75 3.75 0 0 1 3.75 3.75v1.875c0 1.036.84 1.875 1.875 1.875H16.5a3.75 3.75 0 0 1 3.75 3.75v7.875c0 1.035-.84 1.875-1.875 1.875H5.625a1.875 1.875 0 0 1-1.875-1.875V3.375c0-1.036.84-1.875 1.875-1.875Zm5.845 17.03a.75.75 0 0 0 1.06 0l3-3a.75.75 0 1 0-1.06-1.06l-1.72 1.72V12a.75.75 0 0 0-1.5 0v4.19l-1.72-1.72a.75.75 0 0 0-1.06 1.06l3 3Z" clip-rule="evenodd" />
            <path d="M14.25 5.25a5.23 5.23 0 0 0-1.279-3.434 9.768 9.768 0 0 1 6.963 6.963A5.23 5.23 0 0 0 16.5 7.5h-1.875a.375.375 0 0 1-.375-.375V5.25Z" />
        </symbol>
        <symbol id="icon-edit-03" viewBox="0 0 24 24" fill="currentColor">
            <path d="M21.731 2.269a2.625 2.625 0 0 0-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 0 0 0-3.712ZM19.513 8.199l-3.712-3.712-8.4 8.4a5.25 5.25 0 0 0-1.32 2.214l-.8 2.685a.75.75 0 0 0 .933.933l2.685-.8a5.25 5.25 0 0 0 2.214-1.32l8.4-8.4Z" />
            <path d="M5.25 5.25a3 3 0 0 0-3 3v10.5a3 3 0 0 0 3 3h10.5a3 3 0 0 0 3-3V13.5a.75.75 0 0 0-1.5 0v5.25a1.5 1.5 0 0 1-1.5 1.5H5.25a1.5 1.5 0 0 1-1.5-1.5V8.25a1.5 1.5 0 0 1 1.5-1.5h5.25a.75.75 0 0 0 0-1.5H5.25Z" />
        </symbol>
    </svg>

    <div class="container">
        <header>
            <div class="page-header">
                <a href="index.html" class="icon-btn back-icon-btn" title="Back">
                    <svg><use xlink:href="#icon-arrow-back"></use></svg>
                </a>
                <h1>Manage Plan</h1>
                <div id="user-info" style="display: none;">
                    <img id="user-photo">
                </div>
            </div>
        </header>

        <div id="active-program-status-bar" class="glass-card" style="display: none;">
            <div id="active-program-info">
                <span id="active-program-name"></span>
                <span id="active-program-week"></span>
            </div>
            <button id="stop-program-btn" class="action-btn destructive-btn">Stop</button>
        </div>

        <div id="app-content" style="display: none;">
            <div id="main-content-wrapper" style="display: none;">
                <div id="schedule-section">
                    <h2>Weekly Schedule</h2>
                    <div id="schedule-list" class="glass-card" style="padding: 10px;"></div>
                </div>

                <div id="workouts-section" style="margin-top: 30px;">
                    <div class="page-header">
                        <h2>Workout Plans</h2>
                        <button id="show-add-options-btn" class="action-btn add-plan-circle-btn" title="Add Plan">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                        </button>
                    </div>
                    <div id="workouts-list"></div>
                </div>

                <div id="programs-section" style="margin-top: 30px;">
                    <div class="page-header">
                        <h2>Programs</h2>
                        <button id="add-program-btn" class="action-btn add-plan-circle-btn" title="Add Program">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                        </button>
                    </div>
                    <div id="programs-list"></div>
                </div>

            </div>
            <div id="skeleton-loader">
                <div class="skeleton-title skeleton"></div>
                <div class="skeleton sk-schedule-card">
                    <div class="sk-schedule-item"><div class="skeleton sk-schedule-label"></div><div class="skeleton sk-schedule-select"></div></div>
                    <div class="sk-schedule-item"><div class="skeleton sk-schedule-label"></div><div class="skeleton sk-schedule-select"></div></div>
                    <div class="sk-schedule-item"><div class="skeleton sk-schedule-label"></div><div class="skeleton sk-schedule-select"></div></div>
                    <div class="sk-schedule-item"><div class="skeleton sk-schedule-label"></div><div class="skeleton sk-schedule-select"></div></div>
                </div>
                <div class="sk-workouts-header">
                    <div class="skeleton-title skeleton"></div>
                    <div class="sk-workouts-buttons">
                        <div class="skeleton sk-button-icon"></div>
                    </div>
                </div>
                <div class="skeleton sk-workout-item"></div>
                <div class="skeleton sk-workout-item"></div>
            </div>
        </div>
        <div id="sign-in-prompt" style="display: none; text-align: center; margin-top: 50px;">
            <h2>Please Sign In</h2>
            <p>You need to be signed in to manage your workout plan.</p>
            <a href="index.html" class="action-btn" style="background-color: var(--system-blue); color: var(--text-on-action);">Go to Sign In Page</a>
        </div>
    </div>

    <div class="modal-overlay" id="add-options-overlay">
        <div class="overlay-content glass-card" id="add-options-panel">
            <div class="overlay-header">
                <h2>Add a New Workout Plan</h2>
                <button class="icon-btn" id="close-add-options-btn"><svg><use xlink:href="#icon-close"></use></svg></button>
            </div>
            <div class="overlay-body" id="add-options-list">
                <button id="add-manual-btn" class="menu-style-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 1 1-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 0 0 4.486-6.336l-3.276 3.277a3.004 3.004 0 0 1-2.25-2.25l3.276-3.276a4.5 4.5 0 0 0-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437 1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008Z" />
                    </svg>
                    <span>Add Manually</span>
                </button>
                <button id="import-from-file-btn" class="menu-style-btn">
                    <svg><use xlink:href="#icon-file-import"></use></svg>
                    <span>Import from File</span>
                </button>
                <button id="open-ai-transcribe-btn" class="menu-style-btn">
                    <img src="images/Rosecurve.png" alt="AI Icon">
                    <span>Transcribe with AI</span>
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="add-program-options-overlay">
        <div class="overlay-content glass-card" id="add-program-options-panel">
            <div class="overlay-header">
                <h2>Add a New Program</h2>
                <button class="icon-btn" id="close-add-program-options-btn"><svg><use xlink:href="#icon-close"></use></svg></button>
            </div>
            <div class="overlay-body" id="add-program-options-list">
                <button id="add-program-manual-btn" class="menu-style-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 1 1-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 0 0 4.486-6.336l-3.276 3.277a3.004 3.004 0 0 1-2.25-2.25l3.276-3.276a4.5 4.5 0 0 0-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437 1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008Z" />
                    </svg>
                    <span>Create Manually</span>
                </button>
                <button id="import-program-from-file-btn" class="menu-style-btn">
                    <svg><use xlink:href="#icon-file-import"></use></svg>
                    <span>Import from File</span>
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="ai-transcribe-overlay">
        <div class="overlay-content glass-card" id="ai-transcribe-panel">
            <div class="overlay-header">
                <h2 id="ai-transcribe-title">Transcribe with AI</h2>
                <button class="icon-btn" id="close-ai-transcribe-btn"><svg><use xlink:href="#icon-close"></use></svg></button>
            </div>
            <div class="overlay-body">
                <p id="ai-transcribe-description" style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0;"></p>
                <div class="editor-form-group">
                    <label for="gemini-api-key">Google Gemini API Key (<a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--system-blue);">Get one here</a>)</label>
                    <input type="password" id="gemini-api-key" placeholder="Enter your API key">
                </div>
                <div class="editor-form-group" id="ai-plan-name-group">
                    <label for="ai-plan-name">New Plan Name</label>
                    <input type="text" id="ai-plan-name" placeholder="e.g., My Hypertrophy Push Day">
                </div>
                <div class="editor-form-group">
                    <label for="ai-file-input">Workout File</label>
                    <input type="file" id="ai-file-input" accept=".pdf,.txt,.csv,.md">
                </div>
                <button id="transcribe-btn" class="action-btn" style="width: 100%; background-color: var(--system-blue); color: var(--text-on-action);">
                    <span class="btn-text">Transcribe</span>
                    <div class="loader"></div>
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="editor-overlay">
        <div class="overlay-content glass-card" id="editor-panel">
            <div class="overlay-header">
                <h2 id="editor-title">Edit Plan</h2>
                <div class="editor-header-controls">
                    <button class="icon-btn" id="reorder-exercises-btn" title="Reorder Exercises"><svg><use xlink:href="#icon-reorder"></use></svg></button>
                    <button class="icon-btn" id="close-editor-btn"><svg><use xlink:href="#icon-close"></use></svg></button>
                </div>
            </div>
            <div class="overlay-body" id="editor-exercises-list"></div>
            <div class="overlay-footer" id="editor-footer">
                <button class="action-btn" id="done-reordering-btn" style="background-color: var(--system-green); color: var(--text-on-action); grid-column: 1 / -1;">
                    <span class="btn-text">Done</span>
                </button>
                <button class="action-btn" id="add-exercise-btn" style="background-color: rgba(255,255,255,0.1);">
                    <span class="btn-text">Add Exercise</span>
                </button>
                <button class="action-btn" id="save-workouts-btn" style="background-color: var(--system-blue); color: var(--text-on-action);">
                    <span class="btn-text">Save Changes</span>
                    <div class="loader"></div>
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="program-editor-overlay">
        <div class="overlay-content glass-card" id="program-editor-panel">
            <div class="overlay-header">
                <h2 id="program-editor-title">Edit Program</h2>
                <button class="icon-btn" id="close-program-editor-btn"><svg><use xlink:href="#icon-close"></use></svg></button>
            </div>
            <div class="overlay-body" id="program-editor-body">
                <div class="editor-form-group">
                    <label for="program-name-input">Program Name</label>
                    <input type="text" id="program-name-input" placeholder="e.g., My 8-Week Hypertrophy">
                </div>
                <div id="program-weeks-list">
                    <!-- Week blocks will be dynamically inserted here -->
                </div>
            </div>
            <div class="overlay-footer" id="program-editor-footer">
                <button class="action-btn" id="add-week-btn" style="background-color: rgba(255,255,255,0.1);">Add Week</button>
                <button class="action-btn" id="save-program-btn" style="background-color: var(--system-blue); color: var(--text-on-action);">
                    <span class="btn-text">Save Program</span>
                    <div class="loader"></div>
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="run-program-overlay">
        <div class="overlay-content glass-card" id="run-program-panel">
            <div class="overlay-header">
                <h2>Run Program</h2>
                <button class="icon-btn" id="close-run-program-btn"><svg><use xlink:href="#icon-close"></use></svg></button>
            </div>
            <div class="overlay-body">
                <p>Select the week you want to start from:</p>
                <div class="editor-form-group">
                    <label for="start-week-select">Starting Week</label>
                    <select id="start-week-select"></select>
                </div>
                <button id="confirm-run-program-btn" class="action-btn" style="width: 100%; background-color: var(--system-green); color: var(--text-on-action);">Start Program</button>
            </div>
        </div>
    </div>
    
    <input type="file" id="import-file-input" accept=".json" style="display: none;">
    <input type="file" id="import-program-file-input" accept=".json" style="display: none;">

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDe-YVkiX81ISLhVfRdC0srkkHi2JQQeSs",
      authDomain: "my-fitness-tracker-797e5.firebaseapp.com",
      projectId: "my-fitness-tracker-797e5",
      storageBucket: "my-fitness-tracker-797e5.firebasestorage.app",
      messagingSenderId: "651004817600",
      appId: "1:651004817600:web:3a277ea0126dfe0388bd25"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- GLOBAL STATE ---
    let currentUser = null;
    let workouts = {};
    let schedule = {};
    let programs = {};
    let activeProgram = null;
    let editingContext = {}; // CRITICAL: {type: 'workout'/'program', name, programName, weekIndex, workoutName}
    let aiContext = {}; // For AI transcription

    // --- DOM ELEMENT GETTERS ---
    const editorOverlay = document.getElementById('editor-overlay');
    const programEditorOverlay = document.getElementById('program-editor-overlay');
    const runProgramOverlay = document.getElementById('run-program-overlay');
    const mainContentWrapper = document.getElementById('main-content-wrapper');
    const skeletonLoader = document.getElementById('skeleton-loader');
    const editorExercisesList = document.getElementById('editor-exercises-list');
    const addOptionsOverlay = document.getElementById('add-options-overlay');
    const addProgramOptionsOverlay = document.getElementById('add-program-options-overlay');
    const aiTranscribeOverlay = document.getElementById('ai-transcribe-overlay');

    // --- UTILITY FUNCTIONS ---
    function showToast(message, type = 'info', duration = 3000) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('exiting');
            toast.addEventListener('animationend', () => toast.remove());
        }, duration);
    }

    function toggleButtonLoading(btn, isLoading) {
        btn.classList.toggle('loading', isLoading);
        btn.disabled = isLoading;
    }

    // --- CORE DATA FUNCTIONS ---
    async function fetchData() {
        if (!currentUser) return;
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data() || {};
        workouts = userData.workouts || {};
        schedule = userData.schedule || {};
        programs = userData.programs || {};
        activeProgram = userData.activeProgram || null;
    }

    async function saveUserData(key, data) {
        if (!currentUser) return;
        try {
            await db.collection('users').doc(currentUser.uid).set({ [key]: data }, { merge: true });
            showToast('Changes saved successfully!', 'success');
        } catch (error) {
            showToast(`Error saving ${key}.`, 'error');
        }
    }

    // --- RENDERING FUNCTIONS ---
    function renderAll() {
        renderSchedule();
        renderWorkouts();
        renderPrograms();
        renderActiveProgramStatus();
    }

    function renderSchedule() {
        const scheduleList = document.getElementById('schedule-list');
        scheduleList.innerHTML = '';
        const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        days.forEach(day => {
            const dayKey = day.toLowerCase();
            const item = document.createElement('div');
            item.className = 'schedule-item';
            
            let standaloneOptions = '';
            let programOptions = '';

            Object.keys(workouts).sort().forEach(workoutName => {
                const selected = schedule[dayKey] === workoutName ? 'selected' : '';
                const option = `<option value="${workoutName}" ${selected}>${workoutName}</option>`;
                if (activeProgram && workoutName.startsWith(activeProgram.programName)) {
                    programOptions += option;
                } else {
                    standaloneOptions += option;
                }
            });

            let optionsHTML = '<option value="Rest Day">Rest Day</option>';
            if (standaloneOptions) {
                optionsHTML += `<optgroup label="My Workouts">${standaloneOptions}</optgroup>`;
            }
            if (programOptions) {
                optionsHTML += `<optgroup label="Active Program">${programOptions}</optgroup>`;
            }

            item.innerHTML = `<label for="schedule-${dayKey}">${day}</label><select id="schedule-${dayKey}" data-day="${dayKey}">${optionsHTML}</select>`;
            scheduleList.appendChild(item);
            item.querySelector('select').addEventListener('change', async (e) => {
                schedule[e.target.dataset.day] = e.target.value;
                await saveUserData('schedule', schedule);
            });
        });
    }

    function renderWorkouts() {
        const workoutsList = document.getElementById('workouts-list');
        workoutsList.innerHTML = '';
        
        const standaloneWorkouts = Object.keys(workouts).filter(name => !activeProgram || !name.startsWith(activeProgram.programName));

        if (standaloneWorkouts.length === 0) {
            workoutsList.innerHTML = `<div class="glass-card" style="padding: 30px; text-align: center; margin-top: 10px;"><p style="margin: 0; color: var(--text-secondary); line-height: 1.5;">You don't have any standalone plans yet. <br> Click the '+' button to create one!</p></div>`;
            return;
        }

        standaloneWorkouts.forEach(name => {
            const item = document.createElement('div');
            item.className = 'workout-item glass-card';
            item.innerHTML = `<span class="workout-item-name">${name}</span>
                <div class="workout-item-actions">
                    <button class="icon-btn options-menu-btn" data-name="${name}" data-type="workout" title="Options">
                        <svg><use xlink:href="#icon-ellipsis-vertical"></use></svg>
                    </button>
                </div>`;
            workoutsList.appendChild(item);
        });
    }

    function renderPrograms() {
        const programsList = document.getElementById('programs-list');
        programsList.innerHTML = '';

        if (Object.keys(programs).length === 0) {
            programsList.innerHTML = `<div class="glass-card" style="padding: 30px; text-align: center; margin-top: 10px;"><p style="margin: 0; color: var(--text-secondary); line-height: 1.5;">You don't have any programs yet. <br> Click the '+' button to create one!</p></div>`;
            return;
        }

        Object.keys(programs).forEach(name => {
            const item = document.createElement('div');
            item.className = 'workout-item glass-card';
            item.innerHTML = `<span class="workout-item-name">${name}</span>
                <div class="workout-item-actions">
                    <button class="icon-btn options-menu-btn" data-name="${name}" data-type="program" title="Options">
                        <svg><use xlink:href="#icon-ellipsis-vertical"></use></svg>
                    </button>
                </div>`;
            programsList.appendChild(item);
        });
    }

    function renderActiveProgramStatus() {
        const statusBar = document.getElementById('active-program-status-bar');
        if (!activeProgram || !programs[activeProgram.programName]) {
            statusBar.style.display = 'none';
            return;
        }

        const weeksPassed = Math.floor((new Date() - new Date(activeProgram.startDate)) / (1000 * 60 * 60 * 24 * 7));
        const currentProgramWeek = weeksPassed + 1;

        document.getElementById('active-program-name').textContent = `Running: ${activeProgram.programName}`;
        document.getElementById('active-program-week').textContent = `(Week ${currentProgramWeek})`;
        statusBar.style.display = 'flex';
    }

    // --- OPTIONS MENU LOGIC ---
    function closeOptionsMenu() {
        const existingMenu = document.querySelector('.options-menu-popup');
        if (existingMenu) existingMenu.remove();
    }

    function openOptionsMenu(button) {
        const name = button.dataset.name;
        const type = button.dataset.type;
        const actionContainer = button.parentElement;

        if (actionContainer.querySelector('.options-menu-popup')) {
            closeOptionsMenu();
            return;
        }
        closeOptionsMenu();

        const menu = document.createElement('div');
        menu.className = 'options-menu-popup glass-card';
        
        let menuItems = `
            <button class="menu-item" data-action="share">
                <svg class="share-icon-menu" stroke-width="2"><use xlink:href="#icon-share"></use></svg>
                <span>Share</span>
            </button>
            <button class="menu-item" data-action="edit">
                <svg class="edit-icon-menu"><use xlink:href="#icon-edit-03"></use></svg>
                <span>Edit</span>
            </button>
            <button class="menu-item delete-item" data-action="delete">
                <svg class="delete-icon-menu"><use xlink:href="#icon-cancel-circle-sharp"></use></svg>
                <span>Delete</span>
            </button>
        `;
        if (type === 'program') {
            menuItems = `<button class="menu-item" data-action="run"><span>Run Program</span></button>` + menuItems;
        }
        menu.innerHTML = menuItems;
        actionContainer.appendChild(menu);

        menu.addEventListener('click', (e) => {
            const actionItem = e.target.closest('.menu-item');
            if (!actionItem) return;
            const action = actionItem.dataset.action;

            if (type === 'workout') {
                if (action === 'edit') openEditor({ type: 'workout', name: name });
                else if (action === 'delete') deleteWorkout(name);
                else if (action === 'share') exportSingleWorkout(name);
            } else if (type === 'program') {
                if (action === 'edit') openProgramEditor(name);
                else if (action === 'delete') deleteProgram(name);
                else if (action === 'run') showRunProgramPrompt(name);
                else if (action === 'share') exportProgram(name);
            }
            closeOptionsMenu();
        });
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.workout-item-actions')) {
            closeOptionsMenu();
        }
        const optionsBtn = e.target.closest('.options-menu-btn');
        if (optionsBtn) {
            openOptionsMenu(optionsBtn);
        }
    });

    // --- WORKOUT & PROGRAM CRUD ---
    async function addWorkoutManually() {
        const name = prompt("Enter a name for the new workout plan:");
        if (name && !workouts[name]) {
            workouts[name] = [{ name: "", warmupSets: "", workingSets: "", reps: "", rest: "", earlySetRPE: "", lastSetRPE: "" }];
            await saveUserData('workouts', workouts);
            renderAll();
            openEditor({ type: 'workout', name: name });
        } else if (name) {
            showToast("A workout with this name already exists.", 'error');
        }
    }
    
    async function addProgramManually() {
        const name = prompt("Enter a name for the new program:");
        if (name && !programs[name]) {
            programs[name] = { name: name, weeks: [] };
            await saveUserData('programs', programs);
            renderAll();
            openProgramEditor(name);
        } else if (name) {
            showToast("A program with this name already exists.", 'error');
        }
    }

    async function deleteWorkout(name) {
        if (confirm(`Are you sure you want to delete the workout plan "${name}"?`)) {
            const newWorkouts = { ...workouts };
            delete newWorkouts[name];
            
            const newSchedule = { ...schedule };
            for (const day in newSchedule) {
                if (newSchedule[day] === name) newSchedule[day] = "Rest Day";
            }
            
            await db.collection('users').doc(currentUser.uid).update({
                workouts: newWorkouts,
                schedule: newSchedule
            });

            workouts = newWorkouts;
            schedule = newSchedule;
            renderAll();
            showToast('Workout deleted successfully!', 'success');
        }
    }

    async function deleteProgram(name) {
        if (confirm(`Are you sure you want to delete the program "${name}"? This cannot be undone.`)) {
            if (activeProgram && activeProgram.programName === name) {
                await stopProgram(true); // Stop silently if it's the active one
            }
            delete programs[name];
            await saveUserData('programs', programs);
            renderAll();
            showToast('Program deleted successfully!', 'success');
        }
    }

    // --- EXERCISE EDITOR (Context-Aware) ---
    function openEditor(context) {
        editingContext = context;
        let workoutData;
        let title;

        try {
            if (context.type === 'workout') {
                workoutData = workouts[context.name];
                title = `Editing: ${context.name}`;
            } else { // type === 'program'
                workoutData = programs[context.programName].weeks[context.weekIndex].workouts[context.workoutName];
                title = `Editing: ${context.workoutName} (W${context.weekIndex + 1})`;
            }
            if (!workoutData) throw new Error("Workout data not found.");
        } catch (err) {
            showToast("Could not load workout data to edit.", "error");
            return;
        }
        
        document.getElementById('editor-title').textContent = title;
        editorExercisesList.innerHTML = '';
        workoutData.forEach((ex, index) => editorExercisesList.appendChild(createExerciseEditorForm(ex, index)));
        editorOverlay.classList.add('active');
    }

    function closeEditor() {
        editorOverlay.classList.remove('active');
        if (document.getElementById('editor-panel').classList.contains('reorder-mode')) {
            toggleReorderMode(false);
        }
    }

    function createExerciseEditorForm(exercise, index) {
        const div = document.createElement('div');
        div.className = 'editor-exercise glass-card';
        const ex = { name: exercise.name || "", warmupSets: exercise.warmupSets || "", workingSets: exercise.workingSets || "", reps: exercise.reps || "", rest: exercise.rest || "", earlySetRPE: exercise.earlySetRPE || "", lastSetRPE: exercise.lastSetRPE || "" };
        
        div.innerHTML = `
            <div class="editor-exercise-header">
                <h4 class="exercise-title">
                    <span class="exercise-number">Exercise ${index + 1}</span>
                    <span class="exercise-name-title">${ex.name || 'New Exercise'}</span>
                </h4>
                <button class="icon-btn delete-exercise-btn" title="Remove Exercise">
                    <svg style="fill: var(--system-red);"><use xlink:href="#icon-close"></use></svg>
                </button>
            </div>
            <div class="editor-exercise-body">
                <div class="editor-form-group">
                    <label>Name</label>
                    <input type="text" value="${ex.name}" data-key="name" class="exercise-name-input">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="editor-form-group"><label>Warmup Sets</label><input type="number" value="${ex.warmupSets}" data-key="warmupSets"></div>
                    <div class="editor-form-group"><label>Working Sets</label><input type="number" value="${ex.workingSets}" data-key="workingSets"></div>
                    <div class="editor-form-group"><label>Reps</label><input type="text" value="${ex.reps}" data-key="reps"></div>
                    <div class="editor-form-group"><label>Rest (e.g., "90s" or "2 min")</label><input type="text" value="${ex.rest}" data-key="rest"></div>
                    <div class="editor-form-group"><label>Early RPE</label><input type="text" value="${ex.earlySetRPE}" data-key="earlySetRPE"></div>
                    <div class="editor-form-group"><label>Last RPE</label><input type="text" value="${ex.lastSetRPE}" data-key="lastSetRPE"></div>
                </div>
            </div>
        `;

        div.querySelector('.delete-exercise-btn').addEventListener('click', () => {
            div.remove();
            updateExerciseNumbers();
        });

        const nameInput = div.querySelector('.exercise-name-input');
        const nameTitle = div.querySelector('.exercise-name-title');
        nameInput.addEventListener('input', () => {
            nameTitle.textContent = nameInput.value || 'New Exercise';
        });

        return div;
    }

    function updateExerciseNumbers() {
        const exercises = document.querySelectorAll('#editor-exercises-list .editor-exercise');
        exercises.forEach((ex, index) => {
            const numSpan = ex.querySelector('.exercise-number');
            if (numSpan) numSpan.textContent = `Exercise ${index + 1}`;
        });
    }

    document.getElementById('add-exercise-btn').addEventListener('click', () => {
        const newExercise = { name: "", warmupSets: "", workingSets: "", reps: "", rest: "", earlySetRPE: "", lastSetRPE: "" };
        editorExercisesList.appendChild(createExerciseEditorForm(newExercise, editorExercisesList.children.length));
        editorExercisesList.scrollTop = editorExercisesList.scrollHeight;
    });

    document.getElementById('save-workouts-btn').addEventListener('click', async () => {
        const btn = document.getElementById('save-workouts-btn');
        toggleButtonLoading(btn, true);

        const newWorkoutData = Array.from(document.querySelectorAll('#editor-exercises-list .editor-exercise')).map(form => {
            const exercise = {};
            form.querySelectorAll('.editor-exercise-body input').forEach(input => {
                exercise[input.dataset.key] = input.type === 'number' ? parseInt(input.value, 10) || 0 : input.value;
            });
            return exercise;
        });

        try {
            if (editingContext.type === 'workout') {
                workouts[editingContext.name] = newWorkoutData;
                await saveUserData('workouts', workouts);
            } else { // type === 'program'
                programs[editingContext.programName].weeks[editingContext.weekIndex].workouts[editingContext.workoutName] = newWorkoutData;
                await saveUserData('programs', programs);
                if (activeProgram && activeProgram.programName === editingContext.programName) {
                    await checkActiveProgram(true); // Force update the live workout
                }
            }
            renderAll();
            closeEditor();
        } catch (error) {
            showToast("Error saving changes.", "error");
        } finally {
            toggleButtonLoading(btn, false);
        }
    });

    // --- PROGRAM EDITOR ---
    function openProgramEditor(programName) {
        editingContext = { type: 'program', name: programName };
        const program = programs[programName];
        document.getElementById('program-editor-title').textContent = programName ? `Editing: ${programName}` : 'Create New Program';
        document.getElementById('program-name-input').value = programName || '';
        
        const weeksList = document.getElementById('program-weeks-list');
        weeksList.innerHTML = '';

        if (program && program.weeks) {
            program.weeks.forEach((week, index) => {
                weeksList.appendChild(createWeekBlock(week, index));
            });
        }

        programEditorOverlay.classList.add('active');
    }

    function createWeekBlock(weekData, index) {
        const div = document.createElement('div');
        div.className = 'program-week-block';
        div.dataset.weekIndex = index;
        
        let workoutsHTML = '';
        if (weekData.workouts) {
            Object.keys(weekData.workouts).forEach(workoutName => {
                workoutsHTML += `
                    <div class="week-workout-item" data-workout-name="${workoutName}">
                        <span class="workout-name">${workoutName}</span>
                        <div class="actions">
                            <button class="action-btn ai-transcribe-btn">AI</button>
                            <button class="action-btn edit-week-workout-btn">Edit</button>
                            <button class="action-btn delete-week-workout-btn destructive-btn">Del</button>
                        </div>
                    </div>
                `;
            });
        }

        div.innerHTML = `
            <div class="program-week-header">
                <div class="editor-form-group">
                    <label>Week Label (e.g., "Week 1")</label>
                    <input type="text" class="week-label-input" value="${weekData.weekLabel || ''}">
                </div>
                <button class="icon-btn delete-week-btn" title="Delete Week"><svg style="fill: var(--system-red);"><use xlink:href="#icon-close"></use></svg></button>
            </div>
            <div class="program-week-workouts-list">${workoutsHTML}</div>
            <button class="action-btn add-workout-to-week-btn">Add Workout to Week</button>
        `;
        return div;
    }

    async function saveProgram() {
        const btn = document.getElementById('save-program-btn');
        toggleButtonLoading(btn, true);

        const newProgramName = document.getElementById('program-name-input').value.trim();
        if (!newProgramName) {
            showToast("Program name cannot be empty.", "error");
            toggleButtonLoading(btn, false);
            return;
        }

        const oldProgramName = editingContext.name;
        const tempProgram = programs[oldProgramName] || { name: oldProgramName, weeks: [] };
        
        const newProgramData = {
            name: newProgramName,
            weeks: []
        };

        document.querySelectorAll('.program-week-block').forEach((weekBlock, index) => {
            const weekLabel = weekBlock.querySelector('.week-label-input').value;
            const existingWorkouts = tempProgram.weeks[index]?.workouts || {};
            newProgramData.weeks.push({ weekLabel, workouts: existingWorkouts });
        });

        if (oldProgramName && oldProgramName !== newProgramName) {
            delete programs[oldProgramName];
        }
        
        programs[newProgramName] = newProgramData;
        await saveUserData('programs', programs);
        
        toggleButtonLoading(btn, false);
        programEditorOverlay.classList.remove('active');
        renderAll();
    }

    // --- PROGRAM LOGIC ---
    function showRunProgramPrompt(programName) {
        const program = programs[programName];
        if (!program || !program.weeks || program.weeks.length === 0) {
            showToast("This program has no weeks to run.", "error");
            return;
        }
        const select = document.getElementById('start-week-select');
        select.innerHTML = '';
        program.weeks.forEach((week, index) => {
            select.innerHTML += `<option value="${index}">${week.weekLabel || `Week ${index + 1}`}</option>`;
        });
        
        const confirmBtn = document.getElementById('confirm-run-program-btn');
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        
        newConfirmBtn.addEventListener('click', () => runProgram(programName, parseInt(select.value, 10)));
        runProgramOverlay.classList.add('active');
    }

    async function runProgram(programName, startWeekIndex) {
        if (activeProgram) {
            await stopProgram(true); // Stop silently
        }

        activeProgram = {
            programName: programName,
            startDate: new Date().toISOString(),
            startWeekIndex: startWeekIndex
        };

        await saveUserData('activeProgram', activeProgram);
        await checkActiveProgram(true); // Force an initial sync
        
        runProgramOverlay.classList.remove('active');
        renderAll();
        showToast(`Program "${programName}" is now active!`, 'success');
    }

    async function stopProgram(silent = false) {
        if (!activeProgram) return;
        if (!silent && !confirm("Are you sure you want to stop the current program? This will remove its workouts from your schedule options.")) return;

        const prefix = `${activeProgram.programName} - `;
        const newWorkouts = { ...workouts };
        for (const key in newWorkouts) {
            if (key.startsWith(prefix)) delete newWorkouts[key];
        }

        const newSchedule = { ...schedule };
        for (const day in newSchedule) {
            if (newSchedule[day].startsWith(prefix)) {
                newSchedule[day] = "Rest Day";
            }
        }
        
        const batch = db.batch();
        const userRef = db.collection('users').doc(currentUser.uid);
        batch.update(userRef, { workouts: newWorkouts, schedule: newSchedule });
        batch.update(userRef, { activeProgram: firebase.firestore.FieldValue.delete() });
        await batch.commit();

        workouts = newWorkouts;
        schedule = newSchedule;
        activeProgram = null;

        if (!silent) {
            renderAll();
            showToast("Program stopped.", "info");
        }
    }

    async function checkActiveProgram(forceUpdate = false) {
        if (!activeProgram) return;
        const programBlueprint = programs[activeProgram.programName];
        if (!programBlueprint) {
            await stopProgram(true);
            return;
        }

        const weeksPassed = Math.floor((new Date() - new Date(activeProgram.startDate)) / (1000 * 60 * 60 * 24 * 7));
        let targetWeekIndex = activeProgram.startWeekIndex + weeksPassed;
        targetWeekIndex = Math.min(targetWeekIndex, programBlueprint.weeks.length - 1);

        const targetWorkouts = programBlueprint.weeks[targetWeekIndex]?.workouts;
        if (!targetWorkouts) return;

        let needsDbUpdate = false;
        for (const workoutName in targetWorkouts) {
            const prefixedName = `${activeProgram.programName} - ${workoutName}`;
            if (forceUpdate || JSON.stringify(workouts[prefixedName] || null) !== JSON.stringify(targetWorkouts[workoutName])) {
                workouts[prefixedName] = JSON.parse(JSON.stringify(targetWorkouts[workoutName]));
                needsDbUpdate = true;
            }
        }

        if (needsDbUpdate) {
            await saveUserData('workouts', workouts);
            if (forceUpdate) renderAll();
            else showToast(`Program updated to Week ${weeksPassed + 1}!`, 'success');
        }
    }

    // --- AI & IMPORT/EXPORT ---
    function getWorkoutAiPrompt() {
        return `You are an expert fitness assistant. Your task is to analyze the provided user file and transcribe it into a structured JSON format. The output MUST be a single, valid JSON array of exercise objects. Your entire response must be only the JSON data. Do not include any text, explanations, or markdown formatting like \`\`\`json outside of the JSON array. Each exercise object in the array must have the following keys: "name", "warmupSets", "workingSets", "reps", "rest", "earlySetRPE", "lastSetRPE".
                            
Warm-up Sets Rule: For the "warmupSets" key, you must provide a single integer representing the *count* of warm-up sets listed for that exercise. For example, if the text says '2 warm-up sets' or lists two separate warm-up lines (e.g., 'Warm-up: 50lbs x 10, 70lbs x 5'), the value for "warmupSets" must be the number 2. If a range is provided (e.g., "1-2 warm-up sets"), you must always choose the lower number in the range (in this case, 1). If no warm-ups are mentioned, the value should be 0.

RPE Handling Rules: If no RPE is mentioned, set both "earlySetRPE" and "lastSetRPE" to an empty string "". If only ONE RPE value is mentioned (e.g., "RPE 8"), set BOTH "earlySetRPE" and "lastSetRPE" to that same value (e.g., "~8"). If two distinct RPEs are mentioned, assign them correctly. If a value is not present, use a sensible default or an empty string. Be intelligent about common abbreviations. Your entire response must be only the JSON data, starting with [ and ending with ].`;
    }

    function getProgramAiPrompt(programName, weekLabel, workoutName) {
        return `You are an expert fitness assistant. Your task is to analyze the provided user file and transcribe the exercises specifically for the workout named '${workoutName}' as described for the period labeled '${weekLabel}' within the program titled '${programName}'. Your entire response MUST be a single, valid JSON array of exercise objects. Each object must have these keys: "name", "warmupSets", "workingSets", "reps", "rest", "earlySetRPE", "lastSetRPE". Look for contextual clues in the document to find the correct section. If you cannot find a specific match, return an empty array []. Do not include any text, explanations, or markdown formatting like \`\`\`json outside of the JSON array.`;
    }

    document.getElementById('transcribe-btn').addEventListener('click', async () => {
        const apiKey = document.getElementById('gemini-api-key').value;
        const file = document.getElementById('ai-file-input').files[0];
        
        let systemPrompt;
        if (aiContext.type === 'workout') {
            const planName = document.getElementById('ai-plan-name').value.trim();
            if (!apiKey || !planName || !file) {
                showToast("Please fill out all AI fields.", "error"); return;
            }
            if (workouts[planName]) {
                showToast(`Plan "${planName}" already exists.`, "error"); return;
            }
            systemPrompt = getWorkoutAiPrompt();
        } else { // type === 'program'
             if (!apiKey || !file) {
                showToast("Please provide an API key and file.", "error"); return;
            }
            systemPrompt = getProgramAiPrompt(aiContext.programName, aiContext.weekLabel, aiContext.workoutName);
        }

        const btn = document.getElementById('transcribe-btn');
        toggleButtonLoading(btn, true);
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            const dataUrl = reader.result;
            const base64Data = dataUrl.substring(dataUrl.indexOf(',') + 1);
            const mimeType = dataUrl.substring(dataUrl.indexOf(':') + 1, dataUrl.indexOf(';'));
            try {
                const requestBody = {
                    contents: [{ parts: [{ text: "Analyze the attached workout file and return only the JSON data." }, { inline_data: { mime_type: mimeType, data: base64Data } }] }],
                    generationConfig: { temperature: 0 },
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                };

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || "API request failed.");
                }
                
                const data = await response.json();
                const rawText = data.candidates[0].content.parts[0].text;
                const jsonString = rawText.substring(rawText.indexOf('['), rawText.lastIndexOf(']') + 1);
                const newExercises = JSON.parse(jsonString);

                if (aiContext.type === 'workout') {
                    const planName = document.getElementById('ai-plan-name').value.trim();
                    workouts[planName] = newExercises;
                    await saveUserData('workouts', workouts);
                    showToast(`Successfully added "${planName}"!`, 'success');
                } else { // type === 'program'
                    programs[aiContext.programName].weeks[aiContext.weekIndex].workouts[aiContext.workoutName] = newExercises;
                    await saveUserData('programs', programs);
                    showToast(`Successfully transcribed "${aiContext.workoutName}"!`, 'success');
                    openProgramEditor(aiContext.programName); // Refresh editor
                }
                
                renderAll();
                aiTranscribeOverlay.classList.remove('active');

            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                toggleButtonLoading(btn, false);
            }
        };
        reader.onerror = () => {
            showToast("Error reading the file.", "error");
            toggleButtonLoading(btn, false);
        };
    });
    
    function exportSingleWorkout(name) { /* ... original implementation ... */ }
    function exportProgram(name) {
        if (!programs[name]) {
            showToast("Program not found.", "error");
            return;
        }
        const programToExport = { [name]: programs[name] };
        const dataStr = JSON.stringify(programToExport, null, 2);
        const dataBlob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(dataBlob);
        const a = document.createElement('a');
        const safeName = name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        a.href = url;
        a.download = `program_${safeName}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast(`Exported "${name}" successfully!`, "success");
    }

    async function handleFileImport(event, type) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (typeof importedData !== 'object' || importedData === null) { throw new Error("Invalid JSON format."); }
                
                if (type === 'workout') {
                    workouts = { ...workouts, ...importedData };
                    await saveUserData('workouts', workouts);
                } else { // type === 'program'
                    programs = { ...programs, ...importedData };
                    await saveUserData('programs', programs);
                }
                renderAll();
                showToast(`${type.charAt(0).toUpperCase() + type.slice(1)}s imported successfully!`, "success");
            } catch (error) {
                showToast(`Import failed: ${error.message}`, "error");
            } finally {
                event.target.value = '';
            }
        };
        reader.onerror = () => showToast("Error reading the file.", "error");
        reader.readAsText(file);
    }

    // --- REORDER LOGIC ---
    const editorPanel = document.getElementById('editor-panel');
    const reorderBtn = document.getElementById('reorder-exercises-btn');
    const doneReorderingBtn = document.getElementById('done-reordering-btn');
    let draggableItem = null;
    let pointerStart = { x: 0, y: 0 };
    let itemsCache = [];
    const ITEMS_GAP = 15;

    function toggleReorderMode(enable) {
        editorPanel.classList.toggle('reorder-mode', enable);
    }

    reorderBtn.addEventListener('click', () => toggleReorderMode(true));
    doneReorderingBtn.addEventListener('click', () => toggleReorderMode(false));

    function dragStart(e) {
        if (!editorPanel.classList.contains('reorder-mode')) return;
        draggableItem = e.target.closest('.editor-exercise');
        if (!draggableItem) return;
        e.preventDefault();
        pointerStart.x = e.clientX || e.touches[0].clientX;
        pointerStart.y = e.clientY || e.touches[0].clientY;
        draggableItem.classList.add('is-draggable');
        itemsCache = Array.from(editorExercisesList.children);
        const draggableIndex = itemsCache.indexOf(draggableItem);
        itemsCache.forEach((item, index) => {
            if (item === draggableItem) return;
            item.classList.add('is-idle');
            if (index < draggableIndex) item.dataset.isAbove = '';
        });
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag, { passive: false });
        document.addEventListener('mouseup', dragEnd);
        document.addEventListener('touchend', dragEnd);
    }

    function drag(e) {
        if (!draggableItem) return;
        e.preventDefault();
        const currentX = e.clientX || e.touches[0].clientX;
        const currentY = e.clientY || e.touches[0].clientY;
        const pointerOffset = { x: currentX - pointerStart.x, y: currentY - pointerStart.y };
        draggableItem.style.transform = `translate(${pointerOffset.x}px, ${pointerOffset.y}px)`;
        updateIdleItemsStateAndPosition();
    }

    function dragEnd() {
        if (!draggableItem) return;
        applyNewItemsOrder();
        cleanup();
    }

    function cleanup() {
        itemsCache.forEach(item => {
            item.classList.remove('is-draggable', 'is-idle');
            delete item.dataset.isAbove;
            delete item.dataset.isToggled;
            item.style.transform = '';
        });
        draggableItem = null;
        itemsCache = [];
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('touchmove', drag);
        document.removeEventListener('mouseup', dragEnd);
        document.removeEventListener('touchend', dragEnd);
        updateExerciseNumbers();
    }

    function updateIdleItemsStateAndPosition() {
        const draggableRect = draggableItem.getBoundingClientRect();
        const draggableCenterY = draggableRect.top + draggableRect.height / 2;
        itemsCache.forEach(item => {
            if (item === draggableItem) return;
            const itemRect = item.getBoundingClientRect();
            const itemCenterY = itemRect.top + itemRect.height / 2;
            const isAbove = item.hasAttribute('data-is-above');
            if (isAbove) {
                if (draggableCenterY <= itemCenterY) item.dataset.isToggled = '';
                else delete item.dataset.isToggled;
            } else {
                if (draggableCenterY >= itemCenterY) item.dataset.isToggled = '';
                else delete item.dataset.isToggled;
            }
        });
        itemsCache.forEach(item => {
            if (item === draggableItem) return;
            if (item.hasAttribute('data-is-toggled')) {
                const direction = item.hasAttribute('data-is-above') ? 1 : -1;
                item.style.transform = `translateY(${direction * (draggableRect.height + ITEMS_GAP)}px)`;
            } else {
                item.style.transform = '';
            }
        });
    }

    function applyNewItemsOrder() {
        const reorderedItems = [];
        itemsCache.forEach((item, index) => {
            if (item === draggableItem) return;
            if (!item.hasAttribute('data-is-toggled')) {
                reorderedItems[index] = item;
                return;
            }
            const newIndex = item.hasAttribute('data-is-above') ? index + 1 : index - 1;
            reorderedItems[newIndex] = item;
        });
        for (let i = 0; i < itemsCache.length; i++) {
            if (typeof reorderedItems[i] === 'undefined') {
                reorderedItems[i] = draggableItem;
                break;
            }
        }
        reorderedItems.forEach(item => editorExercisesList.appendChild(item));
    }

    editorExercisesList.addEventListener('mousedown', dragStart);
    editorExercisesList.addEventListener('touchstart', dragStart, { passive: false });

    // --- EVENT LISTENERS ---
    document.getElementById('show-add-options-btn').addEventListener('click', () => addOptionsOverlay.classList.add('active'));
    document.getElementById('close-add-options-btn').addEventListener('click', () => addOptionsOverlay.classList.remove('active'));
    document.getElementById('add-manual-btn').addEventListener('click', () => { addOptionsOverlay.classList.remove('active'); addWorkoutManually(); });
    document.getElementById('import-from-file-btn').addEventListener('click', () => { addOptionsOverlay.classList.remove('active'); document.getElementById('import-file-input').click(); });
    document.getElementById('open-ai-transcribe-btn').addEventListener('click', () => { 
        aiContext = { type: 'workout' };
        document.getElementById('ai-transcribe-title').textContent = 'Transcribe New Workout';
        document.getElementById('ai-transcribe-description').textContent = 'The AI will create a new standalone workout plan for you.';
        document.getElementById('ai-plan-name-group').style.display = 'block';
        addOptionsOverlay.classList.remove('active'); 
        aiTranscribeOverlay.classList.add('active'); 
    });
    document.getElementById('close-ai-transcribe-btn').addEventListener('click', () => aiTranscribeOverlay.classList.remove('active'));
    document.getElementById('import-file-input').addEventListener('change', (e) => handleFileImport(e, 'workout'));
    
    document.getElementById('add-program-btn').addEventListener('click', () => addProgramOptionsOverlay.classList.add('active'));
    document.getElementById('close-add-program-options-btn').addEventListener('click', () => addProgramOptionsOverlay.classList.remove('active'));
    document.getElementById('add-program-manual-btn').addEventListener('click', () => { addProgramOptionsOverlay.classList.remove('active'); addProgramManually(); });
    document.getElementById('import-program-from-file-btn').addEventListener('click', () => { addProgramOptionsOverlay.classList.remove('active'); document.getElementById('import-program-file-input').click(); });
    document.getElementById('import-program-file-input').addEventListener('change', (e) => handleFileImport(e, 'program'));

    document.getElementById('close-editor-btn').addEventListener('click', closeEditor);
    document.getElementById('stop-program-btn').addEventListener('click', () => stopProgram(false));

    document.getElementById('close-program-editor-btn').addEventListener('click', () => programEditorOverlay.classList.remove('active'));
    document.getElementById('save-program-btn').addEventListener('click', saveProgram);
    document.getElementById('close-run-program-btn').addEventListener('click', () => runProgramOverlay.classList.remove('active'));
    
    document.getElementById('add-week-btn').addEventListener('click', () => {
        const weeksList = document.getElementById('program-weeks-list');
        const newIndex = weeksList.children.length;
        const newWeekData = { weekLabel: `Week ${newIndex + 1}`, workouts: {} };
        
        const programName = document.getElementById('program-name-input').value;
        if (!programs[programName]) {
            programs[programName] = { name: programName, weeks: [] };
        }
        programs[programName].weeks.push(newWeekData);
        
        weeksList.appendChild(createWeekBlock(newWeekData, newIndex));
    });

    document.getElementById('program-editor-body').addEventListener('click', e => {
        const programName = document.getElementById('program-name-input').value;
        const weekBlock = e.target.closest('.program-week-block');
        if (!weekBlock) return;
        const weekIndex = parseInt(weekBlock.dataset.weekIndex, 10);

        if (e.target.closest('.edit-week-workout-btn')) {
            const workoutName = e.target.closest('.week-workout-item').dataset.workoutName;
            openEditor({ type: 'program', programName, weekIndex, workoutName });
        } else if (e.target.closest('.add-workout-to-week-btn')) {
            const workoutName = prompt("Enter name for this workout (e.g., Push, Pull):");
            if (workoutName) {
                if (!programs[programName].weeks[weekIndex].workouts) {
                    programs[programName].weeks[weekIndex].workouts = {};
                }
                programs[programName].weeks[weekIndex].workouts[workoutName] = [];
                weekBlock.querySelector('.program-week-workouts-list').appendChild(createWeekWorkoutItem(workoutName));
            }
        } else if (e.target.closest('.ai-transcribe-btn')) {
            const workoutName = e.target.closest('.week-workout-item').dataset.workoutName;
            aiContext = {
                type: 'program',
                programName: programName,
                weekIndex: weekIndex,
                weekLabel: programs[programName].weeks[weekIndex].weekLabel,
                workoutName: workoutName
            };
            document.getElementById('ai-transcribe-title').textContent = `Transcribe for Program`;
            document.getElementById('ai-transcribe-description').textContent = `This will find and transcribe '${workoutName}' for '${aiContext.weekLabel}' and add it to your program.`;
            document.getElementById('ai-plan-name-group').style.display = 'none';
            aiTranscribeOverlay.classList.add('active');
        }
    });

    function createWeekWorkoutItem(workoutName) {
        const div = document.createElement('div');
        div.className = 'week-workout-item';
        div.dataset.workoutName = workoutName;
        div.innerHTML = `
            <span class="workout-name">${workoutName}</span>
            <div class="actions">
                <button class="action-btn ai-transcribe-btn">AI</button>
                <button class="action-btn edit-week-workout-btn">Edit</button>
                <button class="action-btn delete-week-workout-btn destructive-btn">Del</button>
            </div>
        `;
        return div;
    }

    // --- PAGE INITIALIZATION ---
    async function initPageForUser() {
        await fetchData();
        await checkActiveProgram();
        renderAll();

        skeletonLoader.style.display = 'none';
        mainContentWrapper.style.display = 'block';
        mainContentWrapper.style.animation = 'fade-in 0.5s ease-out';
    }

    auth.onAuthStateChanged(async user => {
        currentUser = user;
        const appContent = document.getElementById('app-content');
        const signInPrompt = document.getElementById('sign-in-prompt');
        const userInfoDiv = document.getElementById('user-info');
        if (user) {
            document.getElementById('user-photo').src = user.photoURL;
            appContent.style.display = 'block';
            signInPrompt.style.display = 'none';
            userInfoDiv.style.display = 'flex';
            skeletonLoader.style.display = 'block';
            mainContentWrapper.style.display = 'none';
            await initPageForUser();
        } else {
            appContent.style.display = 'none';
            signInPrompt.style.display = 'block';
            userInfoDiv.style.display = 'none';
            skeletonLoader.style.display = 'block';
            mainContentWrapper.style.display = 'none';
        }
    });
    </script>
</body>
</html>
