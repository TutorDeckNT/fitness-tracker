<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Manage Plan - Fitness Tracker</title>
    <link rel="stylesheet" href="edit-workouts-style.css">
    <link rel="icon" href="images/eagle.png" type="image/png">
</head>
<body>
    <div id="toast-container"></div>
    <svg style="display: none;">
        <symbol id="icon-reorder" viewBox="0 0 24 24" fill="none" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5 7.5 3m0 0L12 7.5M7.5 3v13.5m13.5 0L16.5 21m0 0L12 16.5m4.5 4.5V7.5" />
        </symbol>
        <symbol id="icon-arrow-back" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 6L9 12L15 18"/>
        </symbol>
        <symbol id="icon-ellipsis-vertical" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" />
        </symbol>
        <symbol id="icon-close" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></symbol>
        <symbol id="icon-share" viewBox="0 0 24 24" fill="none">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
        </symbol>
        <symbol id="icon-cancel-circle-sharp" viewBox="0 0 24 24" fill="none">
            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke-width="1.5"/>
            <path d="M14.5 9.5L9.5 14.5" stroke-width="1.5" stroke-linecap="sharp"/>
            <path d="M9.5 9.5L14.5 14.5" stroke-width="1.5" stroke-linecap="sharp"/>
        </symbol>
        <symbol id="icon-file-import" viewBox="0 0 24 24" fill="currentColor">
            <path fill-rule="evenodd" d="M5.625 1.5H9a3.75 3.75 0 0 1 3.75 3.75v1.875c0 1.036.84 1.875 1.875 1.875H16.5a3.75 3.75 0 0 1 3.75 3.75v7.875c0 1.035-.84 1.875-1.875 1.875H5.625a1.875 1.875 0 0 1-1.875-1.875V3.375c0-1.036.84-1.875 1.875-1.875Zm5.845 17.03a.75.75 0 0 0 1.06 0l3-3a.75.75 0 1 0-1.06-1.06l-1.72 1.72V12a.75.75 0 0 0-1.5 0v4.19l-1.72-1.72a.75.75 0 0 0-1.06 1.06l3 3Z" clip-rule="evenodd" />
            <path d="M14.25 5.25a5.23 5.23 0 0 0-1.279-3.434 9.768 9.768 0 0 1 6.963 6.963A5.23 5.23 0 0 0 16.5 7.5h-1.875a.375.375 0 0 1-.375-.375V5.25Z" />
        </symbol>
        <symbol id="icon-edit-03" viewBox="0 0 24 24" fill="currentColor">
            <path d="M21.731 2.269a2.625 2.625 0 0 0-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 0 0 0-3.712ZM19.513 8.199l-3.712-3.712-8.4 8.4a5.25 5.25 0 0 0-1.32 2.214l-.8 2.685a.75.75 0 0 0 .933.933l2.685-.8a5.25 5.25 0 0 0 2.214-1.32l8.4-8.4Z" />
            <path d="M5.25 5.25a3 3 0 0 0-3 3v10.5a3 3 0 0 0 3 3h10.5a3 3 0 0 0 3-3V13.5a.75.75 0 0 0-1.5 0v5.25a1.5 1.5 0 0 1-1.5 1.5H5.25a1.5 1.5 0 0 1-1.5-1.5V8.25a1.5 1.5 0 0 1 1.5-1.5h5.25a.75.75 0 0 0 0-1.5H5.25Z" />
        </symbol>
        <symbol id="icon-play-circle" viewBox="0 0 24 24" fill="none" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.91 11.672a.375.375 0 0 1 0 .656l-5.603 3.113a.375.375 0 0 1-.557-.328V8.887c0-.286.307-.466.557-.327l5.603 3.112Z" />
        </symbol>
    </svg>

    <div class="container">
        <header>
            <div class="page-header">
                <a href="index.html" class="icon-btn back-icon-btn" title="Back">
                    <svg><use xlink:href="#icon-arrow-back"></use></svg>
                </a>
                <h1>Manage Plan</h1>
                <div id="user-info" style="display: none;">
                    <img id="user-photo">
                </div>
            </div>
        </header>

        <div id="app-content" style="display: none;">
            <div id="main-content-wrapper" style="display: none;">
                <div id="schedule-section">
                    <h2>Weekly Schedule</h2>
                    <div id="active-program-banner" class="glass-card" style="display: none;"></div>
                    <div id="schedule-list" class="glass-card" style="padding: 10px;"></div>
                </div>

                <div id="workouts-section" style="margin-top: 30px;">
                    <div class="page-header">
                        <h2>Workout Plans</h2>
                        <button id="show-add-options-btn" class="action-btn add-plan-circle-btn" title="Add Plan">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                        </button>
                        <input type="file" id="import-file-input" accept=".json" style="display: none;">
                    </div>
                    <div id="workouts-list"></div>
                </div>

                <div id="programs-section" style="margin-top: 30px;">
                    <div class="page-header">
                        <h2>Workout Programs</h2>
                        <button id="show-add-program-options-btn" class="action-btn add-plan-circle-btn" title="Add Program">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                        </button>
                        <input type="file" id="import-program-file-input" accept=".json" style="display: none;">
                    </div>
                    <div id="programs-list"></div>
                </div>

            </div>
            <div id="skeleton-loader">
                <div class="skeleton-title skeleton"></div>
                <div class="skeleton sk-schedule-card">
                    <div class="sk-schedule-item"><div class="skeleton sk-schedule-label"></div><div class="skeleton sk-schedule-select"></div></div>
                    <div class="sk-schedule-item"><div class="skeleton sk-schedule-label"></div><div class="skeleton sk-schedule-select"></div></div>
                    <div class="sk-schedule-item"><div class="skeleton sk-schedule-label"></div><div class="skeleton sk-schedule-select"></div></div>
                    <div class="sk-schedule-item"><div class="skeleton sk-schedule-label"></div><div class="skeleton sk-schedule-select"></div></div>
                </div>
                <div class="sk-workouts-header">
                    <div class="skeleton-title skeleton"></div>
                    <div class="sk-workouts-buttons">
                        <div class="skeleton sk-button-icon"></div>
                    </div>
                </div>
                <div class="skeleton sk-workout-item"></div>
                <div class="skeleton sk-workout-item"></div>
            </div>
        </div>
        <div id="sign-in-prompt" style="display: none; text-align: center; margin-top: 50px;">
            <h2>Please Sign In</h2>
            <p>You need to be signed in to manage your workout plan.</p>
            <a href="index.html" class="action-btn" style="background-color: var(--system-blue); color: var(--text-on-action);">Go to Sign In Page</a>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal-overlay" id="add-options-overlay">
        <div class="overlay-content glass-card" id="add-options-panel">
            <div class="overlay-header">
                <h2 id="add-options-title">Add a New Plan</h2>
                <button class="icon-btn" id="close-add-options-btn"><svg><use xlink:href="#icon-close"></use></svg></button>
            </div>
            <div class="overlay-body" id="add-options-list">
                <button id="add-manual-btn" class="menu-style-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 1 1-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 0 0 4.486-6.336l-3.276 3.277a3.004 3.004 0 0 1-2.25-2.25l3.276-3.276a4.5 4.5 0 0 0-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437 1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008Z" />
                    </svg>
                    <span>Add Manually</span>
                </button>
                <button id="import-from-file-btn" class="menu-style-btn">
                    <svg><use xlink:href="#icon-file-import"></use></svg>
                    <span>Import from File</span>
                </button>
                <button id="open-ai-transcribe-btn" class="menu-style-btn">
                    <img src="images/Rosecurve.png" alt="AI Icon">
                    <span>Transcribe with AI</span>
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="ai-transcribe-overlay">
        <div class="overlay-content glass-card" id="ai-transcribe-panel">
            <div class="overlay-header">
                <h2 id="ai-transcribe-title">Transcribe with AI</h2>
                <button class="icon-btn" id="close-ai-transcribe-btn"><svg><use xlink:href="#icon-close"></use></svg></button>
            </div>
            <div class="overlay-body">
                <p id="ai-transcribe-description" style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0;">Get a free Google Gemini API key and upload a file containing a <b>single workout day</b>. The AI will automatically create a new plan for you.</p>
                <div class="editor-form-group">
                    <label for="gemini-api-key">Google Gemini API Key (<a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--system-blue);">Get one here</a>)</label>
                    <input type="password" id="gemini-api-key" placeholder="Enter your API key">
                </div>
                <div class="editor-form-group">
                    <label for="ai-plan-name">New Plan/Program Name</label>
                    <input type="text" id="ai-plan-name" placeholder="e.g., My Hypertrophy Push Day">
                </div>
                <div class="editor-form-group">
                    <label for="ai-file-input">Workout File</label>
                    <input type="file" id="ai-file-input" accept=".pdf,.txt,.csv,.md">
                </div>
                <button id="transcribe-btn" class="action-btn" style="width: 100%; background-color: var(--system-blue); color: var(--text-on-action);">
                    <span class="btn-text">Transcribe</span>
                    <div class="loader"></div>
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="editor-overlay">
        <div class="overlay-content glass-card" id="editor-panel">
            <div class="overlay-header">
                <h2 id="editor-title">Edit Plan</h2>
                <div class="editor-header-controls">
                    <button class="icon-btn" id="reorder-exercises-btn" title="Reorder Exercises"><svg><use xlink:href="#icon-reorder"></use></svg></button>
                    <button class="icon-btn" id="close-editor-btn"><svg><use xlink:href="#icon-close"></use></svg></button>
                </div>
            </div>
            <div class="overlay-body" id="editor-exercises-list"></div>
            <div class="overlay-footer" id="editor-footer">
                <button class="action-btn" id="done-reordering-btn" style="background-color: var(--system-green); color: var(--text-on-action); grid-column: 1 / -1;">
                    <span class="btn-text">Done</span>
                </button>
                <button class="action-btn" id="add-exercise-btn" style="background-color: rgba(255,255,255,0.1);">
                    <span class="btn-text">Add Exercise</span>
                </button>
                <button class="action-btn" id="save-workouts-btn" style="background-color: var(--system-blue); color: var(--text-on-action);">
                    <span class="btn-text">Save Changes</span>
                    <div class="loader"></div>
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="program-editor-overlay">
        <div class="overlay-content glass-card" id="program-editor-panel">
            <div class="overlay-header">
                <h2 id="program-editor-title">Edit Program</h2>
                <button class="icon-btn" id="close-program-editor-btn"><svg><use xlink:href="#icon-close"></use></svg></button>
            </div>
            <div class="overlay-body" id="program-weeks-list"></div>
            <div class="overlay-footer" id="program-editor-footer">
                <button class="action-btn" id="add-week-block-btn" style="background-color: rgba(255,255,255,0.1);">
                    <span class="btn-text">Add Week Block</span>
                </button>
                <button class="action-btn" id="save-program-btn" style="background-color: var(--system-blue); color: var(--text-on-action);">
                    <span class="btn-text">Save Program</span>
                    <div class="loader"></div>
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="week-block-editor-overlay">
        <div class="overlay-content glass-card">
            <div class="overlay-header">
                <h2 id="week-block-editor-title">Add Week Block</h2>
                <button class="icon-btn" id="close-week-block-editor-btn"><svg><use xlink:href="#icon-close"></use></svg></button>
            </div>
            <div class="overlay-body week-block-form">
                <div class="editor-form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label for="week-start-input">Start Week</label>
                        <input type="number" id="week-start-input" min="1">
                    </div>
                    <div>
                        <label for="week-end-input">End Week</label>
                        <input type="number" id="week-end-input" min="1">
                    </div>
                </div>
                <hr style="border-color: var(--glass-border); margin: 15px 0;">
                <div id="week-block-schedule-editor"></div>
            </div>
            <div class="overlay-footer">
                <button class="action-btn" id="save-week-block-btn" style="background-color: var(--system-blue); color: var(--text-on-action); grid-column: 1 / -1;">
                    <span class="btn-text">Save Week Block</span>
                </button>
            </div>
        </div>
    </div>

    <datalist id="workout-options-datalist"></datalist>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDe-YVkiX81ISLhVfRdC0srkkHi2JQQeSs",
      authDomain: "my-fitness-tracker-797e5.firebaseapp.com",
      projectId: "my-fitness-tracker-797e5",
      storageBucket: "my-fitness-tracker-797e5.firebasestorage.app",
      messagingSenderId: "651004817600",
      appId: "1:651004817600:web:3a277ea0126dfe0388bd25"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null;
    
    // --- DATA STATE ---
    let workouts = {};
    let schedule = {};
    let programs = {};
    let activeProgram = null;

    // --- UI ELEMENTS ---
    const editorOverlay = document.getElementById('editor-overlay');
    const editorExercisesList = document.getElementById('editor-exercises-list');
    const mainContentWrapper = document.getElementById('main-content-wrapper');
    const skeletonLoader = document.getElementById('skeleton-loader');
    const addOptionsOverlay = document.getElementById('add-options-overlay');
    const aiTranscribeOverlay = document.getElementById('ai-transcribe-overlay');
    const programEditorOverlay = document.getElementById('program-editor-overlay');
    const weekBlockEditorOverlay = document.getElementById('week-block-editor-overlay');

    // --- EDITING STATE ---
    let editingContext = null; // { type: 'plan'/'program', name: 'planName', programName?: 'progName', weekIndex?: 0 }
    let currentAddMode = 'plan'; // 'plan' or 'program'

    // --- UTILITY FUNCTIONS ---
    function showToast(message, type = 'info', duration = 3000) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('exiting');
            toast.addEventListener('animationend', () => toast.remove());
        }, duration);
    }

    function toggleButtonLoading(btn, isLoading) {
        btn.classList.toggle('loading', isLoading);
        btn.disabled = isLoading;
    }

    // --- DATA HANDLING ---
    async function fetchData() {
        if (!currentUser) return;
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data() || {};
        workouts = userData.workouts || {};
        schedule = userData.schedule || {};
        programs = userData.programs || {};
        activeProgram = userData.activeProgram || null;
    }

    async function saveUserData(key, data) {
        if (!currentUser) return;
        try {
            await db.collection('users').doc(currentUser.uid).set({ [key]: data }, { merge: true });
            showToast('Changes saved successfully!', 'success');
        } catch (error) {
            showToast(`Error saving ${key}.`, 'error');
        }
    }

    // --- RENDER FUNCTIONS ---
    function renderAll() {
        renderSchedule();
        renderWorkouts();
        renderPrograms();
    }

    function renderSchedule() {
        const scheduleList = document.getElementById('schedule-list');
        const activeProgramBanner = document.getElementById('active-program-banner');
        scheduleList.innerHTML = '';

        if (activeProgram && programs[activeProgram.name]) {
            const program = programs[activeProgram.name];
            const startDate = new Date(activeProgram.startDate);
            const today = new Date();
            const daysSinceStart = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
            const currentProgramWeek = Math.floor(daysSinceStart / 7) + 1;

            const weekBlock = program.weeks.find(w => currentProgramWeek >= w.weekRange[0] && currentProgramWeek <= w.weekRange[1]);
            
            activeProgramBanner.style.display = 'flex';
            activeProgramBanner.innerHTML = `
                <p>${activeProgram.name} - Week ${currentProgramWeek}<br><span>Program is currently active.</span></p>
                <button class="action-btn destructive-btn" style="margin-top: 0; padding: 8px 12px;" onclick="stopProgram()">Stop</button>
            `;

            const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
            days.forEach(day => {
                const dayKey = day.toLowerCase();
                const workoutName = weekBlock ? (weekBlock.schedule[dayKey] || "Rest Day") : "Rest Day";
                const item = document.createElement('div');
                item.className = 'schedule-item program-active';
                item.innerHTML = `<label>${day}</label><span>${workoutName}</span>`;
                scheduleList.appendChild(item);
            });

        } else {
            activeProgramBanner.style.display = 'none';
            const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
            days.forEach(day => {
                const dayKey = day.toLowerCase();
                const item = document.createElement('div');
                item.className = 'schedule-item';
                let optionsHTML = '<option value="Rest Day">Rest Day</option>';
                Object.keys(workouts).forEach(workoutName => {
                    const selected = schedule[dayKey] === workoutName ? 'selected' : '';
                    optionsHTML += `<option value="${workoutName}" ${selected}>${workoutName}</option>`;
                });
                item.innerHTML = `<label for="schedule-${dayKey}">${day}</label><select id="schedule-${dayKey}" data-day="${dayKey}">${optionsHTML}</select>`;
                scheduleList.appendChild(item);
                item.querySelector('select').addEventListener('change', async (e) => {
                    schedule[e.target.dataset.day] = e.target.value;
                    await saveUserData('schedule', schedule);
                });
            });
        }
    }

    function renderWorkouts() {
        const workoutsList = document.getElementById('workouts-list');
        workoutsList.innerHTML = '';
        if (Object.keys(workouts).length === 0) {
            workoutsList.innerHTML = `<div class="glass-card" style="padding: 30px; text-align: center; margin-top: 10px;"><p style="margin: 0; color: var(--text-secondary); line-height: 1.5;">You don't have any plans yet. <br> Click the '+' button to create your first one!</p></div>`;
            return;
        }
        Object.keys(workouts).forEach(name => {
            const item = document.createElement('div');
            item.className = 'workout-item glass-card';
            item.innerHTML = `<span class="workout-item-name">${name}</span>
                <div class="workout-item-actions">
                    <button class="icon-btn options-menu-btn" data-name="${name}" data-type="plan" title="Options">
                        <svg><use xlink:href="#icon-ellipsis-vertical"></use></svg>
                    </button>
                </div>`;
            workoutsList.appendChild(item);
        });
    }

    function renderPrograms() {
        const programsList = document.getElementById('programs-list');
        programsList.innerHTML = '';
        if (Object.keys(programs).length === 0) {
            programsList.innerHTML = `<div class="glass-card" style="padding: 30px; text-align: center; margin-top: 10px;"><p style="margin: 0; color: var(--text-secondary); line-height: 1.5;">You don't have any programs yet. <br> Click the '+' button to create your first one!</p></div>`;
            return;
        }
        Object.keys(programs).forEach(name => {
            const item = document.createElement('div');
            item.className = 'workout-item glass-card';
            item.innerHTML = `<span class="workout-item-name">${name}</span>
                <div class="workout-item-actions">
                    <button class="icon-btn options-menu-btn" data-name="${name}" data-type="program" title="Options">
                        <svg><use xlink:href="#icon-ellipsis-vertical"></use></svg>
                    </button>
                </div>`;
            programsList.appendChild(item);
        });
    }

    // --- OPTIONS MENUS ---
    function closeOptionsMenu() {
        const existingMenu = document.querySelector('.options-menu-popup');
        if (existingMenu) existingMenu.remove();
    }

    document.addEventListener('click', (e) => {
        const optionsBtn = e.target.closest('.options-menu-btn');
        if (optionsBtn) {
            const otherMenu = document.querySelector('.options-menu-popup');
            if(otherMenu && otherMenu.parentElement !== optionsBtn.parentElement) {
                closeOptionsMenu();
            }
            openOptionsMenu(optionsBtn);
            return;
        }
        if (!e.target.closest('.workout-item-actions')) {
            closeOptionsMenu();
        }
    });

    function openOptionsMenu(button) {
        const name = button.dataset.name;
        const type = button.dataset.type; // 'plan' or 'program'
        const actionContainer = button.parentElement;

        if (actionContainer.querySelector('.options-menu-popup')) {
            closeOptionsMenu();
            return;
        }
        closeOptionsMenu();

        const menu = document.createElement('div');
        menu.className = 'options-menu-popup glass-card';
        
        let menuItems = `
            <button class="menu-item" data-action="share">
                <svg class="share-icon-menu"><use xlink:href="#icon-share"></use></svg>
                <span>Share</span>
            </button>
            <button class="menu-item" data-action="edit">
                <svg class="edit-icon-menu"><use xlink:href="#icon-edit-03"></use></svg>
                <span>Edit</span>
            </button>
            <button class="menu-item delete-item" data-action="delete">
                <svg class="delete-icon-menu"><use xlink:href="#icon-cancel-circle-sharp"></use></svg>
                <span>Delete</span>
            </button>
        `;
        if (type === 'program') {
            menuItems = `
            <button class="menu-item" data-action="run">
                <svg class="run-icon-menu"><use xlink:href="#icon-play-circle"></use></svg>
                <span style="color: var(--system-green);">Run Program</span>
            </button>` + menuItems;
        }
        menu.innerHTML = menuItems;

        actionContainer.appendChild(menu);

        menu.addEventListener('click', (e) => {
            const actionItem = e.target.closest('.menu-item');
            if (!actionItem) return;
            const action = actionItem.dataset.action;
            
            if (type === 'plan') {
                if (action === 'share') exportSingleWorkout(name);
                else if (action === 'edit') openEditor(name);
                else if (action === 'delete') deleteWorkout(name);
            } else { // program
                if (action === 'run') runProgram(name);
                else if (action === 'share') exportProgram(name);
                else if (action === 'edit') openProgramEditor(name);
                else if (action === 'delete') deleteProgram(name);
            }
            closeOptionsMenu();
        });
    }

    // --- WORKOUT PLAN ACTIONS ---
    async function addWorkoutManually() {
        const name = prompt("Enter a name for the new workout plan:");
        if (name && !workouts[name]) {
            workouts[name] = [{ name: "", warmupSets: 0, workingSets: 3, reps: "8-12", rest: "60s", earlySetRPE: "~7", lastSetRPE: "~9" }];
            await saveUserData('workouts', workouts);
            renderAll();
            openEditor(name);
        } else if (name) {
            showToast("A workout with this name already exists.", 'error');
        }
    }

    async function deleteWorkout(name) {
        if (!confirm(`Are you sure you want to delete the workout plan "${name}"?`)) return;
        delete workouts[name];
        // Also remove from any program that uses it
        Object.values(programs).forEach(prog => {
            prog.weeks.forEach(week => {
                Object.keys(week.schedule).forEach(day => {
                    if (week.schedule[day] === name) week.schedule[day] = 'Rest Day';
                });
                delete week.workouts[name];
            });
        });
        await db.collection('users').doc(currentUser.uid).update({
            [`workouts.${name}`]: firebase.firestore.FieldValue.delete()
        });
        await saveUserData('programs', programs); // Save changes to programs
        renderAll();
        showToast(`Workout "${name}" deleted.`, 'success');
    }

    function exportSingleWorkout(name) {
        if (!workouts[name]) return;
        const dataStr = JSON.stringify({ [name]: workouts[name] }, null, 2);
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `workout_${name.replace(/[^a-z0-9]/gi, '_')}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    // --- WORKOUT PROGRAM ACTIONS ---
    async function addProgramManually() {
        const name = prompt("Enter a name for the new workout program:");
        if (name && !programs[name]) {
            programs[name] = { programName: name, weeks: [] };
            await saveUserData('programs', programs);
            renderAll();
            openProgramEditor(name);
        } else if (name) {
            showToast("A program with this name already exists.", 'error');
        }
    }

    async function deleteProgram(name) {
        if (!confirm(`Are you sure you want to delete the program "${name}"? This cannot be undone.`)) return;
        if (activeProgram && activeProgram.name === name) {
            await stopProgram(true); // Silently stop program if it's active
        }
        delete programs[name];
        await db.collection('users').doc(currentUser.uid).update({
            [`programs.${name}`]: firebase.firestore.FieldValue.delete()
        });
        renderAll();
        showToast(`Program "${name}" deleted.`, 'success');
    }

    function exportProgram(name) {
        if (!programs[name]) return;
        const dataStr = JSON.stringify({ [name]: programs[name] }, null, 2);
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `program_${name.replace(/[^a-z0-9]/gi, '_')}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    async function runProgram(name) {
        const dateStr = prompt("Enter the start date for this program (YYYY-MM-DD).", new Date().toISOString().split('T')[0]);
        if (!dateStr) return;
        const startDate = new Date(dateStr);
        if (isNaN(startDate.getTime())) {
            showToast("Invalid date format.", "error");
            return;
        }
        activeProgram = { name: name, startDate: dateStr };
        await saveUserData('activeProgram', activeProgram);
        renderAll();
        showToast(`Program "${name}" is now active!`, 'success');
    }

    async function stopProgram(silent = false) {
        if (!confirm("Are you sure you want to stop the active program?") && !silent) return;
        activeProgram = null;
        await db.collection('users').doc(currentUser.uid).update({
            activeProgram: firebase.firestore.FieldValue.delete()
        });
        renderAll();
        if (!silent) showToast("Program stopped.", "info");
    }

    // --- WORKOUT EDITOR (PLAN & PROGRAM) ---
    function openEditor(name, workoutData = null) {
        if (!workoutData) { // Editing a standalone plan
            editingContext = { type: 'plan', name: name };
            workoutData = workouts[name];
        }
        // If workoutData is passed, editingContext is already set by editProgramWorkout

        document.getElementById('editor-title').textContent = `Editing: ${name}`;
        editorExercisesList.innerHTML = '';
        if (workoutData) {
            workoutData.forEach((ex, index) => editorExercisesList.appendChild(createExerciseEditorForm(ex, index)));
        }
        editorOverlay.classList.add('active');
    }

    document.getElementById('save-workouts-btn').addEventListener('click', async () => {
        const btn = document.getElementById('save-workouts-btn');
        toggleButtonLoading(btn, true);

        const newWorkoutData = Array.from(document.querySelectorAll('#editor-exercises-list .editor-exercise')).map(form => {
            const exercise = {};
            form.querySelectorAll('.editor-exercise-body input').forEach(input => { 
                exercise[input.dataset.key] = input.type === 'number' ? parseInt(input.value, 10) || 0 : input.value; 
            });
            return exercise;
        });

        if (editingContext.type === 'plan') {
            workouts[editingContext.name] = newWorkoutData;
            await saveUserData('workouts', workouts);
        } else if (editingContext.type === 'program') {
            const { programName, weekIndex, workoutName } = editingContext;
            programs[programName].weeks[weekIndex].workouts[workoutName] = newWorkoutData;
            await saveUserData('programs', programs);
        }
        
        renderAll();
        toggleButtonLoading(btn, false);
        closeEditor();
    });

    function closeEditor() {
        editorOverlay.classList.remove('active');
        editingContext = null; // Clear context on close
        if (document.getElementById('editor-panel').classList.contains('reorder-mode')) {
            toggleReorderMode(false);
        }
    }

    // --- PROGRAM EDITOR ---
    function openProgramEditor(name) {
        editingProgramName = name;
        programEditorOverlay.classList.add('active');
        document.getElementById('program-editor-title').textContent = `Editing: ${name}`;
        renderProgramWeeks();
    }

    function renderProgramWeeks() {
        const program = programs[editingProgramName];
        const weeksList = document.getElementById('program-weeks-list');
        weeksList.innerHTML = '';
        if (!program || !program.weeks) return;

        program.weeks.forEach((weekBlock, index) => {
            const weekBlockEl = document.createElement('div');
            weekBlockEl.className = 'program-week-block glass-card';
            const weekRangeText = `Weeks ${weekBlock.weekRange[0]}` + (weekBlock.weekRange[1] > weekBlock.weekRange[0] ? `-${weekBlock.weekRange[1]}` : '');
            
            let scheduleHTML = '';
            const days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"];
            days.forEach(day => {
                const workoutName = weekBlock.schedule[day] || 'Rest Day';
                const isClickable = workoutName !== 'Rest Day' ? `class="workout-name-clickable" onclick="editProgramWorkout('${editingProgramName}', ${index}, '${workoutName}')"` : '';
                scheduleHTML += `<div class="day-entry"><strong>${day.charAt(0).toUpperCase() + day.slice(1)}:</strong> <span ${isClickable}>${workoutName}</span></div>`;
            });

            weekBlockEl.innerHTML = `
                <div class="program-week-header">
                    <h3>${weekRangeText}</h3>
                    <div class="week-block-controls">
                        <button class="action-btn destructive-btn" style="padding: 5px 10px; font-size: 0.9rem; margin-top: 0;" onclick="deleteWeekBlock(${index})">Delete</button>
                    </div>
                </div>
                <div class="program-week-schedule">${scheduleHTML}</div>`;
            weeksList.appendChild(weekBlockEl);
        });
    }

    function editProgramWorkout(programName, weekIndex, workoutName) {
        const workoutData = programs[programName].weeks[weekIndex].workouts[workoutName];
        if (!workoutData) {
            showToast("Workout data not found in program.", "error");
            return;
        }
        // Set the context before opening the editor
        editingContext = { type: 'program', programName, weekIndex, workoutName };
        openEditor(workoutName, workoutData);
    }

    document.getElementById('add-week-block-btn').addEventListener('click', () => {
        const program = programs[editingProgramName];
        if (!program) return;

        const nextWeekStart = program.weeks.length > 0 ? Math.max(...program.weeks.map(w => w.weekRange[1])) + 1 : 1;

        document.getElementById('week-block-editor-title').textContent = "Add Week Block";
        document.getElementById('week-start-input').value = nextWeekStart;
        document.getElementById('week-end-input').value = nextWeekStart;
        
        const scheduleEditor = document.getElementById('week-block-schedule-editor');
        const datalist = document.getElementById('workout-options-datalist');
        scheduleEditor.innerHTML = '';
        datalist.innerHTML = Object.keys(workouts).map(w => `<option value="${w}"></option>`).join('');

        const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        days.forEach(day => {
            scheduleEditor.innerHTML += `
                <div class="day-schedule-group">
                    <label for="week-block-${day}">${day}</label>
                    <input type="text" list="workout-options-datalist" id="week-block-${day}" placeholder="Select or type new plan...">
                </div>`;
        });
        weekBlockEditorOverlay.classList.add('active');
    });

    document.getElementById('save-week-block-btn').addEventListener('click', () => {
        const startWeek = parseInt(document.getElementById('week-start-input').value);
        const endWeek = parseInt(document.getElementById('week-end-input').value);
        if (!startWeek || !endWeek || startWeek > endWeek) {
            showToast("Invalid week range.", "error");
            return;
        }

        const newWeekBlock = {
            weekRange: [startWeek, endWeek],
            schedule: {},
            workouts: {}
        };

        const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        days.forEach(day => {
            const dayKey = day.toLowerCase();
            const workoutName = document.getElementById(`week-block-${day}`).value.trim();
            if (workoutName && workoutName !== 'Rest Day') {
                newWeekBlock.schedule[dayKey] = workoutName;
                if (workouts[workoutName]) {
                    // Deep copy existing workout
                    newWeekBlock.workouts[workoutName] = JSON.parse(JSON.stringify(workouts[workoutName]));
                } else {
                    // Create a new blank workout if it doesn't exist
                    newWeekBlock.workouts[workoutName] = [{ name: "New Exercise", warmupSets: 0, workingSets: 3, reps: "8-12", rest: "60s", earlySetRPE: "~7", lastSetRPE: "~9" }];
                }
            }
        });

        programs[editingProgramName].weeks.push(newWeekBlock);
        programs[editingProgramName].weeks.sort((a, b) => a.weekRange[0] - b.weekRange[0]); // Keep sorted
        
        weekBlockEditorOverlay.classList.remove('active');
        renderProgramWeeks();
    });

    function deleteWeekBlock(index) {
        if (!confirm("Are you sure you want to delete this week block?")) return;
        programs[editingProgramName].weeks.splice(index, 1);
        renderProgramWeeks();
    }

    document.getElementById('save-program-btn').addEventListener('click', async () => {
        await saveUserData('programs', programs);
        programEditorOverlay.classList.remove('active');
        renderAll();
    });

    // --- AI TRANSCRIPTION ---
    document.getElementById('transcribe-btn').addEventListener('click', async () => {
        const apiKey = document.getElementById('gemini-api-key').value;
        const file = document.getElementById('ai-file-input').files[0];
        const planName = document.getElementById('ai-plan-name').value.trim();
        if (!apiKey || !planName || !file) {
            showToast("Please fill out all AI fields.", "error");
            return;
        }
        
        const btn = document.getElementById('transcribe-btn');
        toggleButtonLoading(btn, true);

        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            const dataUrl = reader.result;
            const base64Data = dataUrl.substring(dataUrl.indexOf(',') + 1);
            const mimeType = dataUrl.substring(dataUrl.indexOf(':') + 1, dataUrl.indexOf(';'));
            
            let systemPrompt = '';
            let isProgram = currentAddMode === 'program';

            if (isProgram) {
                if (programs[planName]) {
                    showToast(`Program "${planName}" already exists.`, "error");
                    toggleButtonLoading(btn, false);
                    return;
                }
                systemPrompt = `You are an expert fitness assistant. Your task is to analyze the provided user file (a multi-week workout program) and transcribe it into a single, valid JSON object. Your entire response must be only the JSON data. Do not include any text, explanations, or markdown formatting like \`\`\`json outside of the JSON object.

The final JSON object must have two top-level keys: "programName" and "weeks".
- "programName": This should be the name the user provided: "${planName}".
- "weeks": An array of "week block" objects.

Each "week block" object in the "weeks" array represents a period of training with a consistent structure. It must contain the following keys:
1. "weekRange": An array of two integers representing the start and end week for this block. For example, if a plan is the same for weeks 1, 2, 3, and 4, this should be [1, 4]. If it's just for one week, it would be [1, 1].
2. "schedule": An object mapping lowercase day names ("monday", "tuesday", etc.) to the name of the workout for that day (e.g., "Upper (Strength Focus)"). If a day is a rest day, map it to "Rest Day".
3. "workouts": An object where keys are the workout names defined in the "schedule" (e.g., "Upper (Strength Focus)") and values are arrays of exercise objects for that workout.

Each exercise object within the "workouts" array must have the following keys: "name", "warmupSets", "workingSets", "reps", "rest", "earlySetRPE", "lastSetRPE".

Key Rules:
- Analyze the entire document to identify repeating weekly patterns to create the "weekRange". For example, the document shows "WEEK 1", "WEEK 2", etc. Group them if their structure is identical.
- For "warmupSets", provide an integer count. If a range is given (e.g., "1-2"), use the lower number. Default to 0 if not mentioned.
- For RPE values, if only one is given, use it for both "earlySetRPE" and "lastSetRPE". Prepend a "~" to the RPE value. If none, use an empty string "".
- The entire response must be only the JSON data, starting with { and ending with }.`;
            } else { // isPlan
                if (workouts[planName]) {
                    showToast(`Plan "${planName}" already exists.`, "error");
                    toggleButtonLoading(btn, false);
                    return;
                }
                systemPrompt = `You are an expert fitness assistant. Your task is to analyze the provided user file and transcribe it into a structured JSON format. The output MUST be a single, valid JSON array of exercise objects. Your entire response must be only the JSON data. Do not include any text, explanations, or markdown formatting like \`\`\`json outside of the JSON array. Each exercise object in the array must have the following keys: "name", "warmupSets", "workingSets", "reps", "rest", "earlySetRPE", "lastSetRPE".
                            
Warm-up Sets Rule: For the "warmupSets" key, you must provide a single integer representing the *count* of warm-up sets listed for that exercise. For example, if the text says '2 warm-up sets' or lists two separate warm-up lines (e.g., 'Warm-up: 50lbs x 10, 70lbs x 5'), the value for "warmupSets" must be the number 2. If a range is provided (e.g., "1-2 warm-up sets"), you must always choose the lower number in the range (in this case, 1). If no warm-ups are mentioned, the value should be 0.

RPE Handling Rules: If no RPE is mentioned, set both "earlySetRPE" and "lastSetRPE" to an empty string "". If only ONE RPE value is mentioned (e.g., "RPE 8"), set BOTH "earlySetRPE" and "lastSetRPE" to that same value (e.g., "~8"). If two distinct RPEs are mentioned, assign them correctly. If a value is not present, use a sensible default or an empty string. Be intelligent about common abbreviations. Your entire response must be only the JSON data, starting with [ and ending with ].`;
            }

            try {
                const requestBody = {
                    contents: [{
                        parts: [
                            { text: "Analyze the attached workout file and return only the JSON data." },
                            { inline_data: { mime_type: mimeType, data: base64Data } }
                        ]
                    }],
                    generationConfig: {
                        temperature: 0,
                        thinkingConfig: { thinkingBudget: 8192 }
                    },
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                };

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || "API request failed.");
                }
                
                const data = await response.json();
                const rawText = data.candidates[0].content.parts[0].text;
                
                if (isProgram) {
                    const jsonString = rawText.substring(rawText.indexOf('{'), rawText.lastIndexOf('}') + 1);
                    programs[planName] = JSON.parse(jsonString);
                    await saveUserData('programs', programs);
                    showToast(`Successfully added program "${planName}"!`, 'success');
                } else {
                    const jsonString = rawText.substring(rawText.indexOf('['), rawText.lastIndexOf(']') + 1);
                    workouts[planName] = JSON.parse(jsonString);
                    await saveUserData('workouts', workouts);
                    showToast(`Successfully added plan "${planName}"!`, 'success');
                }

                renderAll();
                document.getElementById('ai-plan-name').value = "";
                aiTranscribeOverlay.classList.remove('active');

            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                toggleButtonLoading(btn, false);
            }
        };
        reader.onerror = () => {
            showToast("Error reading the file.", "error");
            toggleButtonLoading(btn, false);
        };
    });
    
    // --- FILE IMPORT HANDLING ---
    async function handleWorkoutImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const importedWorkouts = JSON.parse(e.target.result);
                if (typeof importedWorkouts !== 'object' || importedWorkouts === null) { throw new Error("Invalid JSON format."); }
                const updatedWorkouts = { ...workouts, ...importedWorkouts };
                workouts = updatedWorkouts;
                await saveUserData('workouts', workouts);
                renderAll();
                showToast("Workouts imported successfully!", "success");
            } catch (error) {
                showToast(`Import failed: ${error.message}`, "error");
            } finally {
                event.target.value = '';
            }
        };
        reader.onerror = () => showToast("Error reading the file.", "error");
        reader.readAsText(file);
    }

    async function handleProgramImport(event) {
        // Placeholder for program import logic
        showToast("Program import is not yet implemented.", "info");
        event.target.value = '';
    }

    // --- UI EVENT LISTENERS ---
    document.getElementById('show-add-options-btn').addEventListener('click', () => {
        currentAddMode = 'plan';
        document.getElementById('add-options-title').textContent = 'Add a New Plan';
        addOptionsOverlay.classList.add('active');
    });
    document.getElementById('show-add-program-options-btn').addEventListener('click', () => {
        currentAddMode = 'program';
        document.getElementById('add-options-title').textContent = 'Add a New Program';
        addOptionsOverlay.classList.add('active');
    });

    document.getElementById('close-add-options-btn').addEventListener('click', () => addOptionsOverlay.classList.remove('active'));
    
    document.getElementById('add-manual-btn').addEventListener('click', () => { 
        addOptionsOverlay.classList.remove('active'); 
        if (currentAddMode === 'plan') {
            addWorkoutManually();
        } else {
            addProgramManually();
        }
    });
    
    document.getElementById('import-from-file-btn').addEventListener('click', () => { 
        addOptionsOverlay.classList.remove('active'); 
        if (currentAddMode === 'plan') {
            document.getElementById('import-file-input').click();
        } else {
            document.getElementById('import-program-file-input').click();
        }
    });

    document.getElementById('open-ai-transcribe-btn').addEventListener('click', () => { 
        addOptionsOverlay.classList.remove('active'); 
        if (currentAddMode === 'program') {
            document.getElementById('ai-transcribe-title').textContent = 'Transcribe Program with AI';
            document.getElementById('ai-transcribe-description').innerHTML = `Get a free Google Gemini API key and upload a file containing a <b>multi-week program</b>. The AI will automatically create a new program for you.`;
        } else {
            document.getElementById('ai-transcribe-title').textContent = 'Transcribe Plan with AI';
            document.getElementById('ai-transcribe-description').innerHTML = `Get a free Google Gemini API key and upload a file containing a <b>single workout day</b>. The AI will automatically create a new plan for you.`;
        }
        aiTranscribeOverlay.classList.add('active'); 
    });

    document.getElementById('close-ai-transcribe-btn').addEventListener('click', () => aiTranscribeOverlay.classList.remove('active'));
    document.getElementById('import-file-input').addEventListener('change', handleWorkoutImport);
    document.getElementById('import-program-file-input').addEventListener('change', handleProgramImport);

    [addOptionsOverlay, aiTranscribeOverlay, editorOverlay, programEditorOverlay, weekBlockEditorOverlay].forEach(overlay => {
        overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('active'); });
    });
    document.getElementById('close-editor-btn').addEventListener('click', closeEditor);
    document.getElementById('close-program-editor-btn').addEventListener('click', () => programEditorOverlay.classList.remove('active'));
    document.getElementById('close-week-block-editor-btn').addEventListener('click', () => weekBlockEditorOverlay.classList.remove('active'));
    document.getElementById('close-program-workout-viewer-btn').addEventListener('click', () => programWorkoutViewerOverlay.classList.remove('active'));


    // --- REORDER LOGIC ---
    const editorPanel = document.getElementById('editor-panel');
    const reorderBtn = document.getElementById('reorder-exercises-btn');
    const doneReorderingBtn = document.getElementById('done-reordering-btn');
    
    let draggableItem = null;
    let pointerStart = { x: 0, y: 0 };
    let itemsCache = [];
    const ITEMS_GAP = 15;

    function toggleReorderMode(enable) {
        editorPanel.classList.toggle('reorder-mode', enable);
    }

    reorderBtn.addEventListener('click', () => toggleReorderMode(true));
    doneReorderingBtn.addEventListener('click', () => toggleReorderMode(false));

    function dragStart(e) {
        if (!editorPanel.classList.contains('reorder-mode')) return;
        
        draggableItem = e.target.closest('.editor-exercise');
        if (!draggableItem) return;

        e.preventDefault();

        pointerStart.x = e.clientX || e.touches[0].clientX;
        pointerStart.y = e.clientY || e.touches[0].clientY;

        draggableItem.classList.add('is-draggable');
        itemsCache = Array.from(editorExercisesList.children);
        
        const draggableIndex = itemsCache.indexOf(draggableItem);
        itemsCache.forEach((item, index) => {
            if (item === draggableItem) return;
            item.classList.add('is-idle');
            if (index < draggableIndex) {
                item.dataset.isAbove = '';
            }
        });

        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag, { passive: false });
        document.addEventListener('mouseup', dragEnd);
        document.addEventListener('touchend', dragEnd);
    }

    function drag(e) {
        if (!draggableItem) return;
        e.preventDefault();

        const currentX = e.clientX || e.touches[0].clientX;
        const currentY = e.clientY || e.touches[0].clientY;
        const pointerOffset = { x: currentX - pointerStart.x, y: currentY - pointerStart.y };

        draggableItem.style.transform = `translate(${pointerOffset.x}px, ${pointerOffset.y}px)`;

        updateIdleItemsStateAndPosition();
    }

    function dragEnd() {
        if (!draggableItem) return;
        
        applyNewItemsOrder();
        cleanup();
    }

    function cleanup() {
        itemsCache.forEach(item => {
            item.classList.remove('is-draggable', 'is-idle');
            delete item.dataset.isAbove;
            delete item.dataset.isToggled;
            item.style.transform = '';
        });
        draggableItem = null;
        itemsCache = [];
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('touchmove', drag);
        document.removeEventListener('mouseup', dragEnd);
        document.removeEventListener('touchend', dragEnd);
        updateExerciseNumbers();
    }

    function updateIdleItemsStateAndPosition() {
        const draggableRect = draggableItem.getBoundingClientRect();
        const draggableCenterY = draggableRect.top + draggableRect.height / 2;

        itemsCache.forEach(item => {
            if (item === draggableItem) return;
            const itemRect = item.getBoundingClientRect();
            const itemCenterY = itemRect.top + itemRect.height / 2;
            
            const isAbove = item.hasAttribute('data-is-above');
            if (isAbove) {
                if (draggableCenterY <= itemCenterY) item.dataset.isToggled = '';
                else delete item.dataset.isToggled;
            } else {
                if (draggableCenterY >= itemCenterY) item.dataset.isToggled = '';
                else delete item.dataset.isToggled;
            }
        });

        itemsCache.forEach(item => {
            if (item === draggableItem) return;
            if (item.hasAttribute('data-is-toggled')) {
                const direction = item.hasAttribute('data-is-above') ? 1 : -1;
                item.style.transform = `translateY(${direction * (draggableRect.height + ITEMS_GAP)}px)`;
            } else {
                item.style.transform = '';
            }
        });
    }

    function applyNewItemsOrder() {
        const reorderedItems = [];
        itemsCache.forEach((item, index) => {
            if (item === draggableItem) return;
            if (!item.hasAttribute('data-is-toggled')) {
                reorderedItems[index] = item;
                return;
            }
            const newIndex = item.hasAttribute('data-is-above') ? index + 1 : index - 1;
            reorderedItems[newIndex] = item;
        });

        for (let i = 0; i < itemsCache.length; i++) {
            if (typeof reorderedItems[i] === 'undefined') {
                reorderedItems[i] = draggableItem;
                break;
            }
        }
        
        reorderedItems.forEach(item => editorExercisesList.appendChild(item));
    }

    editorExercisesList.addEventListener('mousedown', dragStart);
    editorExercisesList.addEventListener('touchstart', dragStart, { passive: false });

    // --- PAGE INITIALIZATION ---
    async function initPageForUser() {
        await fetchData();
        renderAll();

        if (skeletonLoader && mainContentWrapper) {
            skeletonLoader.style.display = 'none';
            mainContentWrapper.style.display = 'block';
            mainContentWrapper.style.animation = 'fade-in 0.5s ease-out';
        }
    }

    auth.onAuthStateChanged(async user => {
        currentUser = user;
        const appContent = document.getElementById('app-content');
        const signInPrompt = document.getElementById('sign-in-prompt');
        const userInfoDiv = document.getElementById('user-info');
        if (user) {
            document.getElementById('user-photo').src = user.photoURL;
            appContent.style.display = 'block';
            signInPrompt.style.display = 'none';
            userInfoDiv.style.display = 'flex';

            if (skeletonLoader && mainContentWrapper) {
                skeletonLoader.style.display = 'block';
                mainContentWrapper.style.display = 'none';
            }
            
            await initPageForUser();

        } else {
            appContent.style.display = 'none';
            signInPrompt.style.display = 'block';
            userInfoDiv.style.display = 'none';

            if (skeletonLoader && mainContentWrapper) {
                skeletonLoader.style.display = 'block';
                mainContentWrapper.style.display = 'none';
            }
        }
    });
    </script>
</body>
</html>```
